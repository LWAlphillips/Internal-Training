<script>
// CONFIG
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';
const RECIPIENT_EMAIL = 'your-team@company.com'; // ← CHANGE TO REAL EMAIL

const LINKS = {
  "Fall Protection Awareness": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Hazard Communication (HazCom/GHS)": "https://www.surveymonkey.com/r/LWAHazCom",
  "Indoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Outdoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAHeatIllnessQuiz",
  "Wildfire Smoke Prevention": "https://www.surveymonkey.com/r/LWAWildFireTraining",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP"
};

// Matrix from your pasted "Training Topics" data
const TRAINING_MATRIX = {
  "Foreman": {
    "Required": [
      "Chemical Hazard Safety", "Electrical Safety Awareness", "Employee Orientation / Code of Safe Practice Review",
      "Fall Protection Awareness", "Fire Prevention and Extinguishers", "First Aid/CPR/AED", "Forklift Training",
      "Hazard Communication (HazCom/GHS)", "Indoor Heat Illness Prevention", "Outdoor Heat Illness Prevention",
      "Intro to First Aid", "Machine Safe Guarding", "MEWP Fall Protection", "Mobile Elevated Work Platform",
      "OSHA 10 Certificate", "Personal Protective Equipment", "Silica Awareness Training", "Valley Fever Awareness",
      "Wildfire Smoke Prevention", "Workplace Violence Prevention"
    ],
    "Suggested": ["Confined Space", "LOTO", "OSHA 30 Certificate"],
    "Additional": [
      "40-Hour Hazwoper", "Certified General Electrician", "Certified Rigger and Signaler", "CRIS Certificate",
      "NCCO Crane Operations", "OSHA 500 Certificate", "OSHA 510 Certificate", "Part 46 New Miner", "Part 46 Refresher",
      "Part 48 New Miner", "Part 48 Refresher"
    ],
    "Site Specific": [
      "Air Products- Martinez Safety Indoct", "Andeaver Martinez Site Orientation", "Northern California RSO",
      "OSCA Card", "PG&E SAFE 0101 Training", "Respiratory Fit Testing", "Respiratory Medical Questionnare",
      "Scaffolding Awareness", "Shell Martinez Site Specific", "Silica Dust Exposure", "Tesoro Martinez CA Site Specific"
    ]
  },
  "Crew": {
    "Required": [
      "Chemical Hazard Safety", "Electrical Safety Awareness", "Employee Orientation / Code of Safe Practice Review",
      "Fall Protection Awareness", "Fire Prevention and Extinguishers", "Hazard Communication (HazCom/GHS)",
      "Indoor Heat Illness Prevention", "Outdoor Heat Illness Prevention", "Intro to First Aid", "OSHA 10 Certificate",
      "Personal Protective Equipment", "Silica Awareness Training", "Valley Fever Awareness", "Wildfire Smoke Prevention",
      "Workplace Violence Prevention"
    ],
    "Suggested": ["Confined Space", "Forklift Training", "LOTO", "Machine Safe Guarding", "MEWP Fall Protection", "Mobile Elevated Work Platform"],
    "Additional": [
      "40-Hour Hazwoper", "Certified General Electrician", "Certified Rigger and Signaler", "CRIS Certificate",
      "First Aid/CPR/AED", "NCCO Crane Operations", "OSHA 30 Certificate", "OSHA 500 Certificate", "OSHA 510 Certificate",
      "Part 46 New Miner", "Part 46 Refresher", "Part 48 New Miner", "Part 48 Refresher"
    ],
    "Site Specific": [
      "Air Products- Martinez Safety Indoct", "Andeaver Martinez Site Orientation", "Northern California RSO",
      "OSCA Card", "PG&E SAFE 0101 Training", "Respiratory Fit Testing", "Respiratory Medical Questionnare",
      "Scaffolding Awareness", "Shell Martinez Site Specific", "Silica Dust Exposure", "Tesoro Martinez CA Site Specific"
    ]
  },
  "Office": {
    "Required": ["Employee Orientation / Code of Safe Practice Review", "Workplace Violence Prevention"],
    "Suggested": ["Intro to First Aid"],
    "Additional": ["First Aid/CPR/AED"],
    "Site Specific": []
  }
};

// Helper: Get categories for a position
function getCategoriesForPosition(position) {
  const cats = TRAINING_MATRIX[position] || { Required: [], Suggested: [], Additional: [], "Site Specific": [] };
  // Normalize key for "Site Specific" (in case of space issues)
  cats.SiteSpecific = cats["Site Specific"] || [];
  return cats;
}

// STATE & loadData, parseTextDate, normalizeName, badge, exportPDF (keep as-is from your code)

// EMAIL GENERATOR – uses matrix Required + Site Specific
function openOutlookEmail(normName) {
  const emp = employeeMap[normName];
  if (!emp) return;
  const fullName = emp.original;
  const firstName = fullName.split(' ')[0];
  const position = emp.records[Object.keys(emp.records)[0]]?.['Position'] || 'N/A';
  const cats = getCategoriesForPosition(position);
  const requiredList = [...cats.Required, ...cats.SiteSpecific];

  const actionItems = [];
  requiredList.forEach(topic => {
    const r = emp.records[topic];
    const link = LINKS[topic] || 'Schedule Training';
    if (r && r['Status'] === 'Overdue') {
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`• ${topic} (REQUIRED/Site Specific)\n (Training: ${trainDate} | Expires: ${exp})\n Status: Overdue\n Link: ${link}`);
    } else if (!r) {
      actionItems.push(`• ${topic} (REQUIRED/Site Specific)\n Status: No Record / Missing\n Link: ${link}`);
    }
  });
  cats.Suggested.forEach(topic => {
    const r = emp.records[topic];
    if (r && r['Status'] === 'Overdue') {
      const link = LINKS[topic] || 'Schedule Training';
      const trainDate = r['Training Date'] ? parseTextDate(r['Training Date']) : 'N/A';
      const exp = r['Expiration Date'] ? parseTextDate(r['Expiration Date']) : 'N/A';
      actionItems.push(`• ${topic} (Suggested)\n (Training: ${trainDate} | Expires: ${exp})\n Status: Overdue\n Link: ${link}`);
    }
  });
  const count = actionItems.length;
  const body = `Hi ${firstName} (${position}),
You have ${count} training${count !== 1 ? 's' : ''} needing attention:
${actionItems.join('\n\n') || '• None'}
Please complete as soon as possible.
Generated: ${new Date().toLocaleString()}
LWA Training Tracker`;
  location.href = `mailto:${RECIPIENT_EMAIL}?subject=Training Action Needed: ${encodeURIComponent(fullName)}&body=${encodeURIComponent(body)}`;
}

// showEmployeeDetail – uses matrix categories ONLY
function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  const position = emp.records[Object.keys(emp.records)[0]]?.['Position'] || 'Unknown';
  const cats = getCategoriesForPosition(position);
  const over = Object.entries(emp.records).filter(([,r]) => r['Status'] === 'Overdue').length;
  let html = `<div class="card-body"><div class="d-flex justify-content-between"><h4>${name}</h4><div><button class="btn btn-success btn-sm" onclick="exportPDF()">PDF</button><button class="btn btn-primary btn-sm" onclick="openOutlookEmail('${norm}')">Send Email</button></div></div>`;
  html += `<p class="text-muted mb-1">Position: <strong>${position}</strong> | Trainings grouped by category | Overdues: ${over}</p><div class="table-responsive">`;

  const addSection = (title, topics) => {
    if (topics.length === 0) return;
    html += `<div class="section-header">${title}</div><table class="table table-sm table-hover"><thead><tr><th>Topic</th><th>Training Date</th><th>Completion Date</th><th>Expiration Date</th><th>Days Remaining</th><th>Status</th></tr></thead><tbody>`;
    topics.sort().forEach(topic => {
      const r = emp.records[topic];
      if (r) {
        html += `<tr><td>${topic}</td><td>${parseTextDate(r['Training Date'])}</td><td>${parseTextDate(r['Completion Date'])}</td><td>${parseTextDate(r['Expiration Date'])}</td><td>${r['Days Remaining'] || '-'}</td><td>${badge(r)}</td></tr>`;
      } else {
        html += `<tr class="table-secondary"><td>${topic}</td><td colspan="5"><span class="badge badge-norecord">No Record</span></td></tr>`;
      }
    });
    html += `</tbody></table>`;
  };

  addSection("Required Trainings", cats.Required);
  addSection("Site Specific Trainings", cats.SiteSpecific);
  addSection("Suggested Trainings", cats.Suggested);
  addSection("Additional Trainings", cats.Additional);

  // Extra: Recorded trainings not in matrix for this position
  const extra = Object.keys(emp.records).filter(t => 
    !cats.Required.includes(t) && !cats.SiteSpecific.includes(t) && 
    !cats.Suggested.includes(t) && !cats.Additional.includes(t)
  );
  addSection("Other Recorded Trainings", extra);

  html += `</div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

// ... (keep all other functions: loadData, parseTextDate, normalizeName, badge, exportPDF, buildData, showAllOverdue, renderTopics, populateEmployeeDropdown, dark mode & init unchanged)

// Make sure to call buildData() at the end
buildData();
setInterval(buildData, 600000);
</script>
