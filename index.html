<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LWA Employee Training Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { background:#f4f6f9; font-family:system-ui, -apple-system, sans-serif; }
    .header-section {
      text-align: center;
      padding: 2.5rem 1rem 2rem;
    }
    .main-title {
      font-size: 2rem;
      font-weight: 700;
      color: #007bff;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #555;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    .badge-due { background:#28a745; color:#fff; font-weight:600; }
    .badge-over { background:#dc3545; color:#fff; font-weight:600; }
    .badge-comp { background:#6c757d; color:#fff; }
    .badge-norecord { background:#adb5bd; color:#fff; }
    table th {
      background:#343a40;
      color:#fff;
      font-weight:600;
    }
    .card {
      box-shadow:0 4px 12px rgba(0,0,0,.07);
      border:none;
      border-radius:12px;
    }
    .section-header {
      background:#e9ecef;
      font-weight:bold;
      padding:8px 12px;
      border-radius:8px;
      margin:20px 0 10px;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <!-- Header -->
  <div class="header-section">
    <h1 class="main-title">My LWA Training Record</h1>
    <p class="subtitle lead">Select your name below to view your current training status</p>
    <div class="d-flex justify-content-center mb-3">
      <select id="employeeSelect" class="form-select w-auto" style="min-width:300px; max-width:100%;">
        <option value="">â€” Select your name â€”</option>
      </select>
    </div>
    <div class="d-flex justify-content-center mb-4">
      <button class="btn btn-outline-danger btn-sm" onclick="showAllOverdue()">View All Overdue Trainings</button>
    </div>
    <div class="text-muted small" id="status">Loading training data...</div>
  </div>
  <!-- Training Details Card -->
  <div class="card mx-3 mx-md-5 mb-5 shadow d-none" id="detailPane">
    <div class="card-body p-4">
      <div class="text-center py-5">
        <p class="fs-4 text-muted">Select your name above to view your training record</p>
      </div>
    </div>
  </div>
</div>
<script>
// YOUR CLEAN CSV URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRV7v_0mQWcqJI9ExD7lphRQDaHnyv65Tp_i2uDiBJOcxAJ5l6jXV1-WFFBKSU9YZErgLDkGB6nYmug/pub?output=csv';

const LINKS = {
  "Fall Protection": "https://www.surveymonkey.com/r/LWAFallProtectionQuiz",
  "Hazard Communication (HazCom/GHS)": "https://www.surveymonkey.com/r/LWAHazCom",
  "Indoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAIndoorHeatIllness",
  "Outdoor Heat Illness Prevention": "https://www.surveymonkey.com/r/LWAHeatIllnessQuiz",
  "Wildfire Smoke Prevention": "https://www.surveymonkey.com/r/LWAWildFireTraining",
  "Workplace Violence Prevention": "https://www.surveymonkey.com/r/LWAWVPP"
};

// REQUIRED TRAININGS
const REQUIRED_TRAININGS = [
  "Fall Protection",
  "Hazard Communication (HazCom/GHS)",
  "Indoor Heat Illness Prevention",
  "Outdoor Heat Illness Prevention",
  "Wildfire Smoke Prevention",
  "Workplace Violence Prevention"
];

// SUGGESTED TRAININGS
const SUGGESTED_TRAININGS = [
  "Confined Space",
  "Forklift Training",
  "Mobile Elevated Work Platform",
  "First Aid/CPR/AED",
  "Harassment & Discrimination Training",
  "Workplace Violence Property Assessment"
];

let employeeMap = {}, allOverdue = [];

async function loadData() {
  document.getElementById('status').innerHTML = 'Loading training data...';
  try {
    const resp = await fetch(SHEET_URL + '&_=' + Date.now());
    if (!resp.ok) throw new Error('Failed to load');
    const text = await resp.text();
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) throw new Error('No data');
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const records = lines.slice(1).map(line => {
      const vals = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const rec = {};
      headers.forEach((h, i) => rec[h] = vals[i] || '');
      return rec;
    }).filter(r => r['Employee Name'] && r['Topic']);

    employeeMap = {};
    allOverdue = [];
    records.forEach(r => {
      let topic = r['Topic'];
      if (topic === "Fall Protection Awareness") topic = "Fall Protection";
      const orig = r['Employee Name'];
      const norm = normalizeName(orig);
      if (!norm || !topic) return;
      if (!employeeMap[norm]) employeeMap[norm] = { original: orig, records: {} };
      employeeMap[norm].records[topic] = r;
      // Collect actual overdue
      if (r['Status'] === 'Overdue') {
        allOverdue.push({
          employee: orig,
          topic: topic,
          trainingDate: r['Training Date'],
          expirationDate: r['Expiration Date'],
          daysRemaining: r['Days Remaining']
        });
      }
    });

    // Add required missing as overdue
    Object.values(employeeMap).forEach(emp => {
      REQUIRED_TRAININGS.forEach(topic => {
        if (!emp.records[topic]) {
          allOverdue.push({
            employee: emp.original,
            topic: topic,
            trainingDate: '',
            expirationDate: '',
            daysRemaining: 'N/A'
          });
        }
      });
    });

    // Add suggested/additional overdue (already done in first loop)

    populateEmployeeDropdown();
    document.getElementById('status').innerHTML = '';
  } catch (err) {
    document.getElementById('status').innerHTML = '<span class="text-danger">Error loading data â€” please try again later</span>';
  }
}

function normalizeName(name) {
  return name?.replace(/Perira/gi, 'Pereira')
    .replace(/Silviera/gi, 'Silveira')
    .replace(/[^\w\s]/g, '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ') || '';
}

function parseTextDate(dateStr) {
  if (!dateStr) return 'N/A';
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const match = dateStr.match(/(\w{3})\s+(\d{1,2}),\s+(\d{4})/);
  if (match) {
    const [_, month, day, year] = match;
    return new Date(year, months[month], day).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    return new Date(parts[2], parts[0]-1, parts[1]).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  return dateStr || 'N/A';
}

function badge(r) {
  const s = r['Status'] || '';
  const days = r['Days Remaining'] || '';
  if (s === 'Completed') return `<span class="badge badge-comp">Completed</span>`;
  if (s === 'Not Due') return `<span class="badge badge-due">Not Due${days ? ' (' + days + 'd)' : ''}</span>`;
  if (s === 'Overdue') return `<span class="badge badge-over">Overdue${days ? ' (' + days + 'd)' : ''}</span>`;
  return `<span class="badge bg-secondary text-white">${s || 'â€”'}</span>`;
}

function populateEmployeeDropdown() {
  const sel = document.getElementById('employeeSelect');
  sel.innerHTML = '<option value="">â€” Select your name â€”</option>';
  Object.keys(employeeMap)
    .sort((a,b) => employeeMap[a].original.localeCompare(employeeMap[b].original))
    .forEach(norm => {
      const opt = document.createElement('option');
      opt.value = norm;
      opt.textContent = employeeMap[norm].original;
      sel.appendChild(opt);
    });
  sel.onchange = e => {
    if (e.target.value) {
      showEmployeeDetail(e.target.value);
    } else {
      document.getElementById('detailPane').classList.add('d-none');
    }
  };
}

async function exportPDF() {
  await new Promise(r => setTimeout(r, 1000));
  try {
    const pane = document.querySelector('#detailPane .card-body');
    if (!pane) { alert('Select your name first'); return; }
    const clone = pane.cloneNode(true);
    // Add hyperlinks for PDF
    clone.querySelectorAll('td:first-child').forEach(td => {
      const topic = td.textContent.trim();
      const link = LINKS[topic];
      if (link) {
        td.innerHTML = `<a href="${link}" style="color:#007bff; text-decoration:underline;">${topic}</a>`;
      }
    });
    clone.style.padding = '20px';
    clone.style.background = '#fff';
    document.body.appendChild(clone);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.width = '800px';
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true });
    document.body.removeChild(clone);
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const w = 190;
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(img, 'PNG', 10, 10, w, h);
    const name = pane.querySelector('h3')?.textContent.trim().replace("'s Training Record", '') || 'TrainingRecord';
    pdf.save(`${name}_Training_Record.pdf`);
  } catch (e) {
    console.error(e);
    alert('PDF export failed');
  }
}

function showEmployeeDetail(norm) {
  const emp = employeeMap[norm];
  if (!emp) return;
  const name = emp.original;
  let html = `<div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-4">
      <h3 class="fw-bold">${name}'s Training Record</h3>
      <button class="btn btn-success btn-sm" onclick="exportPDF()">Download PDF</button>
    </div>
    <div class="table-responsive">`;

  const addSection = (title, topics) => {
    if (topics.length === 0) return;
    html += `<div class="section-header">${title}</div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Training Topic</th>
            <th>Training Date</th>
            <th>Completion Date</th>
            <th>Expires</th>
            <th>Days Left</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>`;
    topics.sort().forEach(topic => {
      const r = emp.records[topic];
      const cell = topic;
      if (r) {
        html += `<tr>
          <td>${cell}</td>
          <td>${parseTextDate(r['Training Date'])}</td>
          <td>${parseTextDate(r['Completion Date'])}</td>
          <td>${parseTextDate(r['Expiration Date'])}</td>
          <td>${r['Days Remaining'] || '-'}</td>
          <td>${badge(r)}</td>
        </tr>`;
      } else {
        html += `<tr class="table-light">
          <td>${cell}</td>
          <td colspan="5"><span class="badge badge-norecord">No Record</span></td>
        </tr>`;
      }
    });
    html += `</tbody></table>`;
  };

  addSection("Required Trainings", REQUIRED_TRAININGS);
  addSection("Suggested Trainings", SUGGESTED_TRAININGS);

  const additional = Object.keys(emp.records).filter(t => !REQUIRED_TRAININGS.includes(t) && !SUGGESTED_TRAININGS.includes(t));
  addSection("Additional Trainings", additional);

  html += `</div></div>`;
  document.getElementById('detailPane').innerHTML = html;
  document.getElementById('detailPane').classList.remove('d-none');
}

function showAllOverdue() {
  if (allOverdue.length === 0) {
    document.getElementById('detailPane').innerHTML = `<div class="card-body text-center py-5"><p class="fs-4 text-success">No overdue trainings! ðŸŽ‰</p></div>`;
    return;
  }
  let html = `<div class="card-body">
    <h3 class="text-center mb-4 fw-bold text-danger">All Overdue Trainings (${allOverdue.length})</h3>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Topic</th>
            <th>Training Date</th>
            <th>Expires</th>
            <th>Days Overdue</th>
          </tr>
        </thead>
        <tbody>`;
  allOverdue.sort((a,b) => a.employee.localeCompare(b.employee) || a.topic.localeCompare(b.topic)).forEach(item => {
    const days = item.daysRemaining === 'N/A' ? 'Missing' : Math.abs(item.daysRemaining);
    html += `<tr>
      <td>${item.employee}</td>
      <td>${item.topic}</td>
      <td>${parseTextDate(item.trainingDate)}</td>
      <td>${parseTextDate(item.expirationDate)}</td>
      <td class="text-danger fw-bold">${days}</td>
    </tr>`;
  });
  html += `</tbody></table></div></div>`;
  document.getElementById('detailPane').innerHTML = html;
}

loadData();
</script>
</body>
</html>
